var Ee=require("siyuan");async function w(e,n,t){if(!e.saveData)throw new Error("Plugin saveData method is not available");try{await e.saveData(n,t)}catch(o){throw o}}async function b(e,n){if(!e.loadData)return null;try{return await e.loadData(n)||null}catch(t){return null}}async function R(e,n="config.json"){let t=document.documentElement;if(!t)return;let o=t.getAttribute("data-theme-mode")||"light";t.getAttribute("data-asri-palette")==="amber"&&t.removeAttribute("data-asri-palette");let i=await b(e,n);if(i&&i["asri-enhance-amber"]){let r=i["asri-enhance-amber"];typeof r=="boolean"?delete i["asri-enhance-amber"]:(r[o]=!1,i["asri-enhance-amber"]=r),await w(e,n,i)}}async function q(e,n="config.json"){let t=document.documentElement;if(!t)return;let o=t.getAttribute("data-theme-mode")||"light";t.getAttribute("data-asri-palette")==="wilderness"&&t.removeAttribute("data-asri-palette");let i=await b(e,n);if(i&&i["asri-enhance-wilderness"]){let r=i["asri-enhance-wilderness"];typeof r=="boolean"?delete i["asri-enhance-wilderness"]:(r[o]=!1,i["asri-enhance-wilderness"]=r),await w(e,n,i)}}async function U(e,n="config.json"){let t=document.documentElement;if(!t)return;let o=t.getAttribute("data-theme-mode")||"light";t.getAttribute("data-asri-palette")==="midnight"&&t.removeAttribute("data-asri-palette");let i=await b(e,n);if(i&&i["asri-enhance-midnight"]){let r=i["asri-enhance-midnight"];typeof r=="boolean"?delete i["asri-enhance-midnight"]:(r[o]=!1,i["asri-enhance-midnight"]=r),await w(e,n,i)}}async function z(e,n="config.json"){let t=document.documentElement;if(!t)return;let o=t.getAttribute("data-theme-mode")||"light";t.getAttribute("data-asri-palette")==="salt"&&t.removeAttribute("data-asri-palette");let i=await b(e,n);if(i&&i["asri-enhance-salt"]){let r=i["asri-enhance-salt"];typeof r=="boolean"?delete i["asri-enhance-salt"]:(r[o]=!1,i["asri-enhance-salt"]=r),await w(e,n,i)}}async function ae(e,n="config.json"){let t=document.documentElement;if(!t)return;(t.getAttribute("data-asri-palette")==="amber"||t.getAttribute("data-asri-palette")==="wilderness"||t.getAttribute("data-asri-palette")==="midnight"||t.getAttribute("data-asri-palette")==="salt")&&t.removeAttribute("data-asri-palette"),t.hasAttribute("data-asri-enhance-coloredheading")&&t.removeAttribute("data-asri-enhance-coloredheading");let o=await b(e,n);if(o){let i=Object.keys(o).filter(r=>r.startsWith("asri-enhance-"));i.length>0&&(i.forEach(r=>{delete o[r]}),await w(e,n,o))}}var V="config.json";async function M(e,n,t){let o=document.documentElement;if(!o)return;let i=o.getAttribute("data-theme-mode")||"light";if(o.getAttribute("data-asri-palette")===n.name)return;let a=await b(e,V)||{},l=a[n.configKey]||{light:!1,dark:!1},c=()=>{o.removeAttribute("data-asri-palette"),o.setAttribute("data-asri-palette",n.name),l[i]=!0;for(let f of n.otherConfigKeys)if(a[f]){let u=a[f];typeof u=="object"&&(u[i]=!1,a[f]=u)}a[n.configKey]=l};document.startViewTransition?await document.startViewTransition(()=>{c()}).finished.catch(()=>{}):c(),await w(e,V,a).catch(()=>{})}async function P(e,n){let t=document.documentElement;if(!t)return;let o=t.getAttribute("data-theme-mode")||"light",i=await b(e,V);if(i&&i[n.configKey]){let r=i[n.configKey];(typeof r=="boolean"?r:r[o]===!0)?(t.removeAttribute("data-asri-palette"),t.setAttribute("data-asri-palette",n.name)):t.getAttribute("data-asri-palette")===n.name&&t.removeAttribute("data-asri-palette")}}var se={name:"amber",configKey:"asri-enhance-amber",otherConfigKeys:["asri-enhance-wilderness","asri-enhance-midnight","asri-enhance-salt"]};async function le(e,n){return M(e,se,n)}async function D(e){return P(e,se)}var ce={name:"wilderness",configKey:"asri-enhance-wilderness",otherConfigKeys:["asri-enhance-amber","asri-enhance-midnight","asri-enhance-salt"]};async function ue(e,n){return M(e,ce,n)}async function B(e){return P(e,ce)}var me={name:"midnight",configKey:"asri-enhance-midnight",otherConfigKeys:["asri-enhance-amber","asri-enhance-wilderness","asri-enhance-salt"]};async function de(e,n){return M(e,me,n)}async function N(e){return P(e,me)}var he={name:"salt",configKey:"asri-enhance-salt",otherConfigKeys:["asri-enhance-amber","asri-enhance-wilderness","asri-enhance-midnight"]};async function fe(e,n){return M(e,he,n)}async function F(e){return P(e,he)}var W="config.json",$="asri-enhance-coloredheading";async function ge(e,n){n&&(n.preventDefault(),n.stopPropagation());let t=document.documentElement;if(!t)return;let o=t.hasAttribute("data-asri-enhance-coloredheading"),i=await b(e,W)||{};o?(t.removeAttribute("data-asri-enhance-coloredheading"),i[$]=!1):(t.setAttribute("data-asri-enhance-coloredheading","true"),i[$]=!0),await w(e,W,i).catch(()=>{})}async function K(e){let n=document.documentElement;if(!n)return;let t=await b(e,W);t&&t[$]===!0?n.setAttribute("data-asri-enhance-coloredheading","true"):n.removeAttribute("data-asri-enhance-coloredheading")}var G="config.json",Y="asri-enhance-coloredoutline";async function be(e,n){n&&(n.preventDefault(),n.stopPropagation());let t=document.documentElement;if(!t)return;let o=t.hasAttribute("data-asri-enhance-coloredoutline"),i=await b(e,G)||{};o?(t.removeAttribute("data-asri-enhance-coloredoutline"),i[Y]=!1):(t.setAttribute("data-asri-enhance-coloredoutline","true"),i[Y]=!0),await w(e,G,i).catch(()=>{})}async function j(e){let n=document.documentElement;if(!n)return;let t=await b(e,G);t&&t[Y]===!0?n.setAttribute("data-asri-enhance-coloredoutline","true"):n.removeAttribute("data-asri-enhance-coloredoutline")}function pe(e,n,t=100){let o,i,r=null,a=0,l=new Set,c=10,f=100,u=()=>{l.forEach(m=>window.clearTimeout(m)),l.clear()},T=(m,g)=>{let v=window.setTimeout(()=>{l.delete(v),m()},g);return l.add(v),v},s=m=>{o!==void 0&&window.clearTimeout(o),o=window.setTimeout(()=>{u();let g=(v=0)=>{var H,I,C,O,S;let k=document.querySelector('#commonMenu[data-name="barmode"] #pickColor');if(k){let h=k.parentElement;if(h){if(!h.querySelector("#asri-enhance-palette")){let p=document.createElement("button");p.className="b3-menu__item asri-enhance",p.id="asri-enhance-palette",p.innerHTML=`<svg class="b3-menu__icon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M19 3h-4a2 2 0 0 0-2 2v12a4 4 0 0 0 8 0V5a2 2 0 0 0-2-2"></path><path d="m13 7.35l-2-2a2 2 0 0 0-2.828 0L5.344 8.178a2 2 0 0 0 0 2.828l9 9"></path><path d="M7.3 13H5a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h12m0-4v.01"></path></g></svg><span class="b3-menu__label">${((H=e.i18n)==null?void 0:H.morePresetColors)||"morePresetColors"}</span><svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg><div class="b3-menu__submenu"><div class="b3-menu__items"><button class="b3-menu__item" id="asri-enhance-amber"><svg class="b3-menu__icon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M19 3h-4a2 2 0 0 0-2 2v12a4 4 0 0 0 8 0V5a2 2 0 0 0-2-2"></path><path d="m13 7.35l-2-2a2 2 0 0 0-2.828 0L5.344 8.178a2 2 0 0 0 0 2.828l9 9"></path><path d="M7.3 13H5a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h12m0-4v.01"></path></g></svg><span class="b3-menu__label">${((I=e.i18n)==null?void 0:I.amber)||"amber"}</span></button><button class="b3-menu__item" id="asri-enhance-wilderness"><svg class="b3-menu__icon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M19 3h-4a2 2 0 0 0-2 2v12a4 4 0 0 0 8 0V5a2 2 0 0 0-2-2"></path><path d="m13 7.35l-2-2a2 2 0 0 0-2.828 0L5.344 8.178a2 2 0 0 0 0 2.828l9 9"></path><path d="M7.3 13H5a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h12m0-4v.01"></path></g></svg><span class="b3-menu__label">${((C=e.i18n)==null?void 0:C.wilderness)||"wilderness"}</span></button><button class="b3-menu__item" id="asri-enhance-midnight"><svg class="b3-menu__icon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M19 3h-4a2 2 0 0 0-2 2v12a4 4 0 0 0 8 0V5a2 2 0 0 0-2-2"></path><path d="m13 7.35l-2-2a2 2 0 0 0-2.828 0L5.344 8.178a2 2 0 0 0 0 2.828l9 9"></path><path d="M7.3 13H5a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h12m0-4v.01"></path></g></svg><span class="b3-menu__label">${((O=e.i18n)==null?void 0:O.midnight)||"midnight"}</span></button><button class="b3-menu__item" id="asri-enhance-salt"><svg class="b3-menu__icon" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em" viewBox="0 0 24 24"><g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"><path d="M19 3h-4a2 2 0 0 0-2 2v12a4 4 0 0 0 8 0V5a2 2 0 0 0-2-2"></path><path d="m13 7.35l-2-2a2 2 0 0 0-2.828 0L5.344 8.178a2 2 0 0 0 0 2.828l9 9"></path><path d="M7.3 13H5a2 2 0 0 0-2 2v4a2 2 0 0 0 2 2h12m0-4v.01"></path></g></svg><span class="b3-menu__label">${((S=e.i18n)==null?void 0:S.salt)||"salt"}</span></button></div></div>`,h.insertBefore(p,k)}let ne=h.querySelector("#asri-enhance-amber");ne&&(ne.onclick=p=>le(e,p));let ie=h.querySelector("#asri-enhance-wilderness");ie&&(ie.onclick=p=>ue(e,p));let oe=h.querySelector("#asri-enhance-midnight");oe&&(oe.onclick=p=>de(e,p));let re=h.querySelector("#asri-enhance-salt");re&&(re.onclick=p=>fe(e,p))}n(m);return}v+1<c?T(()=>g(v+1),f):n(m)};g(),o=void 0},t)},d=()=>{let m=document.querySelector("#barMode");if(m){r=m,m.addEventListener("click",s,!0),i=void 0;return}a+=1,a<c?i=window.setTimeout(d,f):i=void 0};return d(),()=>{i!==void 0&&(window.clearTimeout(i),i=void 0),u(),r&&(r.removeEventListener("click",s,!0),r=null),o!==void 0&&(window.clearTimeout(o),o=void 0)}}function ve(e,n=100){let t,o,i=null,r=0,a=new Set,l=10,c=100,f=()=>{a.forEach(d=>window.clearTimeout(d)),a.clear()},u=(d,m)=>{let g=window.setTimeout(()=>{a.delete(g),d()},m);return a.add(g),g},T=d=>{t!==void 0&&window.clearTimeout(t),t=window.setTimeout(()=>{f();let m=(g=0)=>{var k,H,I;let v=document.querySelector('#commonMenu[data-name="barmode"] #topbarFusionPlus');if(v){let C=v.parentElement;if(C){if(!C.querySelector("#asri-enhance-more")){let h=document.createElement("button");h.className="b3-menu__item asri-enhance",h.id="asri-enhance-more",h.innerHTML=`<svg class="b3-menu__icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"><path d="M512 443.733333a68.266667 68.266667 0 1 1-0.034133 136.567467A68.266667 68.266667 0 0 1 512 443.733333z m0-238.933333a68.266667 68.266667 0 1 1-0.034133 136.567467A68.266667 68.266667 0 0 1 512 204.8z m0 477.866667a68.266667 68.266667 0 1 1-0.034133 136.567466A68.266667 68.266667 0 0 1 512 682.666667z" fill="currentColor"></path></svg><span class="b3-menu__label">${((k=e.i18n)==null?void 0:k.more)||"more"}</span><svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg><div class="b3-menu__submenu"><div class="b3-menu__items"><button class="b3-menu__item" id="asri-enhance-colored-heading"><svg class="b3-menu__icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"><path d="M512 443.733333a68.266667 68.266667 0 1 1-0.034133 136.567467A68.266667 68.266667 0 0 1 512 443.733333z m0-238.933333a68.266667 68.266667 0 1 1-0.034133 136.567467A68.266667 68.266667 0 0 1 512 204.8z m0 477.866667a68.266667 68.266667 0 1 1-0.034133 136.567466A68.266667 68.266667 0 0 1 512 682.666667z" fill="currentColor"></path></svg><span class="b3-menu__label">${((H=e.i18n)==null?void 0:H.coloredHeading)||"coloredHeading"}</span></button><button class="b3-menu__item" id="asri-enhance-colored-outline"><svg class="b3-menu__icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" width="1em" height="1em"><path d="M512 443.733333a68.266667 68.266667 0 1 1-0.034133 136.567467A68.266667 68.266667 0 0 1 512 443.733333z m0-238.933333a68.266667 68.266667 0 1 1-0.034133 136.567467A68.266667 68.266667 0 0 1 512 204.8z m0 477.866667a68.266667 68.266667 0 1 1-0.034133 136.567466A68.266667 68.266667 0 0 1 512 682.666667z" fill="currentColor"></path></svg><span class="b3-menu__label">${((I=e.i18n)==null?void 0:I.coloredOutline)||"coloredOutline"}</span></button></div></div>`,v.nextSibling?C.insertBefore(h,v.nextSibling):C.appendChild(h)}let O=C.querySelector("#asri-enhance-colored-heading");O&&(O.onclick=h=>ge(e,h));let S=C.querySelector("#asri-enhance-colored-outline");S&&(S.onclick=h=>be(e,h))}return}g+1<l&&u(()=>m(g+1),c)};m(),t=void 0},n)},s=()=>{let d=document.querySelector("#barMode");if(d){i=d,d.addEventListener("click",T,!0),o=void 0;return}r+=1,r<l?o=window.setTimeout(s,c):o=void 0};return s(),()=>{o!==void 0&&(window.clearTimeout(o),o=void 0),f(),i&&(i.removeEventListener("click",T,!0),i=null),t!==void 0&&(window.clearTimeout(t),t=void 0)}}var J=!1,E=null,X=0,y=null,x=null,_=null,L=null;function Q(){return document.querySelector(".protyle-hint.hint--menu:not(.fn__none)")}function A(){if(J=!1,y=null,E!==null&&(clearInterval(E),E=null),x){try{x.disconnect()}catch(e){}x=null}if(_){try{_.disconnect()}catch(e){}_=null}}function Z(e){return!!(e&&document.body.contains(e)&&!e.classList.contains("fn__none"))}function ee(){if(y){if(!x){x=new MutationObserver(()=>{Z(y)||A()});try{x.observe(y,{attributes:!0,attributeFilter:["class","style"]})}catch(e){}}if(!_){_=new MutationObserver(()=>{Z(y)||A()});try{_.observe(document.body,{childList:!0,subtree:!0})}catch(e){}}}}function Te(){let e=Q();return e?(y=e,ee(),!0):(X=0,E=setInterval(()=>{X+=1;let n=Q();n?(y=n,clearInterval(E),E=null,ee()):X>=10&&(clearInterval(E),E=null,A())},100),!1)}function Ae(e){return e?Array.from(e.querySelectorAll(".b3-list-item")):[]}function Ce(e){return e?e.querySelector(".b3-list-item--focus"):null}function ke(e){return e.map(n=>{let t=n.getBoundingClientRect();return{el:n,x:t.left+t.width/2,y:t.top+t.height/2}})}function xe(e,n,t){if(!n||e.length===0)return null;let o=n.getBoundingClientRect(),i={x:o.left+o.width/2,y:o.top+o.height/2,el:n},r=ke(e),a=Math.max(o.width/2,10),l;switch(t){case"ArrowUp":l=s=>s.y<i.y-1&&Math.abs(s.x-i.x)<=a;break;case"ArrowDown":l=s=>s.y>i.y+1&&Math.abs(s.x-i.x)<=a;break;case"ArrowLeft":l=s=>s.x<i.x-1;break;case"ArrowRight":l=s=>s.x>i.x+1;break;default:return null}let c=r.filter(s=>s.el!==n&&l(s));if(c.length===0)return null;let f=(s,d)=>{let m=s.x-d.x,g=s.y-d.y;return m*m+g*g},u=c[0],T=f(u,i);for(let s=1;s<c.length;s++){let d=f(c[s],i);d<T&&(u=c[s],T=d)}return u.el}function we(e){if(!y||!e)return;let n=Ce(y);if(n!==e){n&&n.classList.remove("b3-list-item--focus"),e.classList.add("b3-list-item--focus");try{e.scrollIntoView({block:"nearest",inline:"nearest"})}catch(t){}}}function _e(e,n){var o,i;let t=e.indexOf(n);return t===-1?(o=e[0])!=null?o:null:t+1<e.length?e[t+1]:(i=e[0])!=null?i:null}function Le(e,n){var o,i;let t=e.indexOf(n);return t===-1?(o=e[e.length-1])!=null?o:null:t-1>=0?e[t-1]:(i=e[e.length-1])!=null?i:null}function ye(e,n){let t=n.getBoundingClientRect(),o=t.top+t.height/2,i=[];for(let r of e){if(r===n)continue;let a=r.getBoundingClientRect(),l=a.top+a.height/2,c=Math.min(t.height,a.height)/2;Math.abs(l-o)<=c&&i.push(r)}return i}function He(e){return e.map(n=>({el:n,x:n.getBoundingClientRect().left})).sort((n,t)=>n.x-t.x).map(n=>n.el)}function Ie(e){return e.map(n=>({el:n,x:n.getBoundingClientRect().left})).sort((n,t)=>t.x-n.x).map(n=>n.el)}var Oe=e=>{var c,f;if(e.key==="/"){A(),J=!0,Te();return}if(!J)return;if(e.key==="Escape"){A();return}if(!["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key))return;let t=y||Q();if(!t||!Z(t)){A();return}e.preventDefault(),e.stopPropagation(),y=t,ee();let o=Ae(t);if(o.length===0)return;let i=Ce(t);i||(i=o[0],i.classList.add("b3-list-item--focus"));let r=xe(o,i,e.key);if(r){we(r);return}let a=null,l=e.key;if(l==="ArrowDown")a=_e(o,i);else if(l==="ArrowUp")a=Le(o,i);else if(l==="ArrowRight"){let u=ye(o,i);u.length>0&&(a=(c=He(u)[0])!=null?c:null)}else if(l==="ArrowLeft"){let u=ye(o,i);u.length>0&&(a=(f=Ie(u)[0])!=null?f:null)}a&&a!==i&&we(a)};function Me(){typeof document!="undefined"&&(L||(L=Oe,document.addEventListener("keydown",L,{capture:!0})))}function Pe(){typeof document!="undefined"&&(L&&(document.removeEventListener("keydown",L,{capture:!0}),L=null),A())}var te=class extends Ee.Plugin{constructor(){super(...arguments);this.unsubscribeBarModeClick=null;this.unsubscribeTopbarFusionPlus=null;this.asriConfigClickHandler=null;this.themeModeObserver=null}async onload(){this.unsubscribeBarModeClick=pe(this,()=>{}),this.unsubscribeTopbarFusionPlus=ve(this),this.asriConfigClickHandler=o=>{let i=o.target;if(!i||i.closest("#asri-enhance-amber")||i.closest("#asri-enhance-wilderness")||i.closest("#asri-enhance-midnight")||i.closest("#asri-enhance-salt"))return;let r=i.closest(".asri-config");r&&r.id!=="topbarFusionPlus"&&(R(this,"config.json").catch(()=>{}),q(this,"config.json").catch(()=>{}),U(this,"config.json").catch(()=>{}),z(this,"config.json").catch(()=>{}))},document.addEventListener("click",this.asriConfigClickHandler,!0);let t=document.documentElement;t&&(this.themeModeObserver=new MutationObserver(o=>{for(let i of o)i.type==="attributes"&&i.attributeName==="data-theme-mode"&&(D(this).catch(()=>{}),B(this).catch(()=>{}),N(this).catch(()=>{}),F(this).catch(()=>{}))}),this.themeModeObserver.observe(t,{attributes:!0,attributeFilter:["data-theme-mode"]})),D(this).catch(()=>{}),B(this).catch(()=>{}),N(this).catch(()=>{}),F(this).catch(()=>{}),K(this).catch(()=>{}),j(this).catch(()=>{}),Me(),setTimeout(()=>{D(this).catch(()=>{}),B(this).catch(()=>{}),N(this).catch(()=>{}),F(this).catch(()=>{}),K(this).catch(()=>{}),j(this).catch(()=>{})},500),setTimeout(()=>{D(this).catch(()=>{}),B(this).catch(()=>{}),N(this).catch(()=>{}),F(this).catch(()=>{}),K(this).catch(()=>{}),j(this).catch(()=>{})},1500)}onunload(){this.unsubscribeBarModeClick&&(this.unsubscribeBarModeClick(),this.unsubscribeBarModeClick=null),this.unsubscribeTopbarFusionPlus&&(this.unsubscribeTopbarFusionPlus(),this.unsubscribeTopbarFusionPlus=null),this.asriConfigClickHandler&&(document.removeEventListener("click",this.asriConfigClickHandler,!0),this.asriConfigClickHandler=null),this.themeModeObserver&&(this.themeModeObserver.disconnect(),this.themeModeObserver=null),Pe()}async uninstall(){this.onunload(),await ae(this,"config.json").catch(()=>{})}};module.exports=te;
